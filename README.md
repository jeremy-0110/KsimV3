# Ksim V3 --- 多資產交易回測系統 (Trading Simulator)

Ksim V3 是一套以 **Python + Streamlit** 打造的互動式金融回測系統。本專案不僅能進行多資產模擬交易，也是示範 **軟體架構重構 (Refactoring)** 與 **AI 輔助開發 (AI-Assisted Development)** 的實戰案例（連README也是生成的）。

---

## 🔗 線上體驗 & 聯絡方式

-   Demo：[https://ksimv3.streamlit.app](https://ksimv3.streamlit.app)
-   Email：jeremy0110aaa@gmail.com

---

## 🛠 開發理念

本專案採用「**人類設計邏輯、AI 協助實作**」的開發模式，並透過架構重構，將臃腫且耦合的系統優化為模組化架構。

### 1. Human-AI Collaboration 工作流程

1.  **Design（人工）**
    -   制定交易規則（如保證金、強制平倉邏輯）
    -   規劃介面需求
    -   設計觀測期與視野分離等系統變數
2.  **Implementation（AI）**
    -   Gemini 協助撰寫 Python 程式
    -   自動偵測邏輯漏洞
    -   提升效能並做模組化拆分

---

## ✨ 核心功能特色

### **1. 多資產支援（Multi-Asset）**

自動套用最小單位與代碼驗證規則，支援：
- 📈 股票（TSLA、NVDA）
- 💱 外匯（JPY=X、EURUSD=X）
- ₿ 加密貨幣（BTC-USD、ETH-USD）

---

### **2. 進階模擬機制（Advanced Simulation）**

#### 🔹 観測期 & 視野分離

-   開始交易前預跑 **250 天**
-   確保長週期 MA（如 MA120）計算準確
-   介面僅顯示最後 **100 天**（避免圖形壓縮）

#### 🔹 保證金交易（Margin Trading）

-   支援 **1x ～ 20x 槓桿**
-   內建 **做空機制**
-   即時計算維持保證金，觸發條件自動執行 **強制平倉（Liquidation）**

---

### **3. 專業視覺化圖表（Plotly）**

-   互動式 K 線、均線、即時標籤
-   顯示持倉成本線、SL/TP 線
-   客製化 hover label 與動態標注

---

## 🚀 Ksim V3 版本更新日誌與功能對照表

Ksim V3 是一次重大升級，專注於提升**圖表分析的深度**、**交易策略的彈性**以及**模擬體驗的流暢度**。以下是 V3 與 V2.1 的詳細差異對照。

---

## ✨ 核心功能差異 (Feature Comparison)

| 功能模組 | Ksim V2.1 (舊版) | Ksim V3 (新版) | 升級亮點 |
| :--- | :--- | :--- | :--- |
| **📊 技術指標** | 僅支援 MA (移動平均線), RSI | 新增 **Bollinger Bands (布林通道)**, **MACD** | 支援更多專業指標，且可**自由開關顯示**，圖表不再雜亂。 |
| **📉 掛單系統** | 無 (僅支援市價單) | **新增限價單 (Limit) 與止損單 (Stop)** | 支援「逢低買進」、「逢高賣出」以及最重要的 **「追價突破」** 策略。 |
| **⏯️ 自動播放** | 無 (需手動點擊下一天) | **新增自動播放系統** | 支援 1~10 倍速播放，遇交易事件**自動暫停**，模擬真實看盤節奏。 |
| **🖊️ 繪圖工具** | 無 | **新增 K 線繪圖功能** | 支援畫直線、矩形、圓形，並提供橡皮擦功能，方便技術分析標註。 |
| **📍 交易標記** | 僅在表格顯示紀錄 | **圖表顯示買賣箭頭** | 在 K 線圖上直接標示 **Buy (🟢)** 與 **Sell (🔴)** 點位，覆盤更直觀。 |
| **💰 資產分析** | 僅顯示當前總資產 | **新增資產成長曲線圖 (Equity Curve)** | 在結算或回測過程中，即時繪製資產變化折線圖，視覺化策略績效。 |

---

## 🛠️ V3 升級詳細說明 (Detailed Upgrade Notes)

### 1. 📊 視覺化與指標升級 (Visualization & Indicators)
* **動態指標切換**：使用者現在可以透過側邊欄的「指標設定」選單，自由勾選想看的指標（MA, BBands, MACD, RSI）。
* **圖表版面優化**：
    * 若選擇外匯 (Forex) 模式，系統會自動隱藏成交量圖表（因為外匯無成交量數據），釋放更多空間給 K 線。
    * MACD 與 RSI 會動態新增子圖，不會擠壓主圖空間。
* **交易足跡**：所有歷史交易（開倉/平倉）都會以帶有顏色的箭頭標示在 K 線圖上，讓您一眼看出「買在哪、賣在哪」。

### 2. 🛒 進階掛單系統 (Advanced Order System)
不再侷限於市價進出，V3 引入了專業的掛單邏輯，並嚴格執行價格檢查：
* **Limit Order (限價單)**
* **Stop Order (止損/突破單)**
* **資金圈存**：掛單時會預扣保證金與手續費，避免資金超用。

### 3. ⏯️ 智能自動播放 (Smart Auto-Play)
* **解放雙手**：不用再瘋狂點擊「下一天」，設定好速度（如每秒 5 根 K 棒）即可自動推進。
* **批量更新 (Batch Update)**：為了減少畫面閃爍，系統支援「一次推進 N 天」的批量渲染技術，讓動畫更流暢。
* **事件驅動暫停**：當發生以下事件時，自動播放會立即暫停，讓您有時間反應：
    * 掛單成交
    * 止損/止盈 (SL/TP) 觸發
    * 強制平倉 (爆倉)
    * 回測數據結束

### 4. 📝 績效分析增強 (Performance Analysis)
* **資產成長曲線 (Equity Curve)**：在交易紀錄下方新增了一張折線圖，記錄從回測開始到現在的每一天總資產變化。
* **最高/最低資產標記**：自動標註資產的歷史高點與低點（若低於本金），讓您清楚看到策略的最大回撤 (MDD) 與潛在獲利。

---

## ⚙️ 技術底層優化 (Under the Hood)
* **Refactoring**：將指標計算邏輯完全分離至 `data_manager.py`，並採用純淨函式 (Pure Function) 設計，避免 Pandas 警告。
* **State Management**：優化了 Streamlit Session State 的管理，解決了元件互動時狀態重置的問題。
* **UX Improvement**：側邊欄加入摺疊選單與防呆機制（如自動播放時鎖定交易面板），提升操作體驗。

---

## 🛠 本地安裝與執行

### 1. 環境需求

-   **Python 3.10+**（建議 3.13）

### 2. 安裝套件

```bash
pip install streamlit pandas numpy yfinance plotly
```

### 3. 執行程式

```bash
streamlit run app.py
```

啟動後瀏覽器將自動打開：
`http://localhost:8501`

---

## 📜 使用說明

本專案僅供教育與學術研究使用，不構成投資建議。
資料來源：Yahoo Finance（請遵守 API 使用規範）

---

## ⚙ Powered by

-   **Python**
-   **Gemini AI**
